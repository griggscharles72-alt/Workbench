bash -c '
set -e

echo "[BOOTSTRAP] Starting full system provisioning..."

install_if_missing() {
  for pkg in "$@"; do
    if ! dpkg -s "$pkg" >/dev/null 2>&1; then
      echo "[+] Installing $pkg"
      sudo apt install -y "$pkg"
    else
      echo "[=] $pkg already installed"
    fi
  done
}

echo "[+] System update..."
sudo apt update -y
sudo apt upgrade -y

echo "[+] Core system packages..."
install_if_missing \
  build-essential gcc g++ make dkms cmake pkg-config \
  git curl wget unzip zip tar \
  software-properties-common ca-certificates gnupg lsb-release apt-transport-https \
  net-tools htop tree jq ripgrep \
  ufw fail2ban auditd audispd-plugins \
  openssl libssl-dev libffi-dev \
  python3 python3-full python3-pip python3-venv python3-dev pipx \
  tor nginx \
  openvpn wireguard wireguard-tools network-manager-openvpn

echo "[+] Python alias..."
if ! command -v python >/dev/null 2>&1; then
  sudo ln -sf /usr/bin/python3 /usr/local/bin/python
fi

echo "[+] Local bin path..."
mkdir -p ~/.local/bin
if ! grep -q ".local/bin" ~/.bashrc; then
  echo "export PATH=\$HOME/.local/bin:\$PATH" >> ~/.bashrc
fi
export PATH=$HOME/.local/bin:$PATH

echo "[+] pipx setup..."
pipx ensurepath || true

echo "[+] Upgrade Python tooling..."
python3 -m pip install --user --upgrade pip setuptools wheel --break-system-packages || true

echo "[+] Python CLI tools..."
pipx install virtualenv 2>/dev/null || true
pipx install ipython 2>/dev/null || true
pipx install httpie 2>/dev/null || true
pipx install rich-cli 2>/dev/null || true

echo "[+] Default Python workspace..."
mkdir -p ~/python-projects
if [ ! -d ~/python-projects/default ]; then
  python3 -m venv ~/python-projects/default
fi

echo "[+] Base Python libraries..."
~/python-projects/default/bin/pip install -U \
  numpy pandas requests psutil rich flask fastapi uvicorn || true

echo "[+] VS Code installation..."
if ! command -v code >/dev/null 2>&1; then
  if [ ! -f /usr/share/keyrings/vscode.gpg ]; then
    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | \
      gpg --dearmor | sudo tee /usr/share/keyrings/vscode.gpg >/dev/null
  fi

  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/vscode.gpg] \
https://packages.microsoft.com/repos/code stable main" | \
  sudo tee /etc/apt/sources.list.d/vscode.list >/dev/null

  sudo apt update -y
  sudo apt install -y code
else
  echo "[=] VS Code already installed"
fi

echo "[+] ProtonVPN CLI..."
if ! command -v protonvpn >/dev/null 2>&1; then
  sudo apt install -y python3-proton-client || true
fi

echo "[+] Enable services..."
sudo systemctl enable ufw --now || true
sudo systemctl enable fail2ban --now || true
sudo systemctl enable auditd --now || true
sudo systemctl enable tor --now || true
sudo systemctl enable nginx --now || true

echo "[+] Firewall baseline..."
sudo ufw allow OpenSSH || true
sudo ufw --force enable || true

echo "[+] Permissions repair..."
sudo chown -R $USER:$USER ~/.local || true

echo "[+] Verification..."
echo "Python:" $(python3 --version)
echo "Pip:" $(pip3 --version)
echo "pipx:" $(pipx --version 2>/dev/null || echo not-found)
echo "GCC:" $(gcc --version | head -n1)
echo "VSCode:" $(code --version 2>/dev/null | head -n1 || echo not-found)

echo "[+] Failed services (if any):"
systemctl --failed --no-pager || true

echo ""
echo "[BOOTSTRAP COMPLETE]"
echo "Activate Python:"
echo "source ~/python-projects/default/bin/activate"
'
